#!/bin/bash
# NOMAD CVE Format Validation Hook
# Validates CVE identifiers in user prompts and suggests corrections

PROMPT="$1"

# Extract potential CVE references from the prompt
CVE_PATTERN='CVE-?[0-9]{4}-?[0-9]{4,}'

# Find all potential CVE references (case insensitive)
POTENTIAL_CVES=$(echo "$PROMPT" | grep -oEi "$CVE_PATTERN" | tr '[:lower:]' '[:upper:]')

if [ -z "$POTENTIAL_CVES" ]; then
    # No CVEs mentioned, nothing to validate
    exit 0
fi

INVALID_CVES=""
VALID_CVES=""

for CVE in $POTENTIAL_CVES; do
    # Normalize the CVE format
    NORMALIZED=$(echo "$CVE" | sed 's/CVE/CVE-/' | sed 's/--/-/g' | sed 's/CVE-\([0-9]\{4\}\)\([0-9]\)/CVE-\1-\2/')

    # Check if it matches the standard format: CVE-YYYY-NNNNN
    if echo "$NORMALIZED" | grep -qE '^CVE-[0-9]{4}-[0-9]{4,}$'; then
        # Extract year
        YEAR=$(echo "$NORMALIZED" | sed 's/CVE-\([0-9]\{4\}\)-.*/\1/')
        CURRENT_YEAR=$(date +%Y)

        # Validate year range (CVEs started in 1999)
        if [ "$YEAR" -ge 1999 ] && [ "$YEAR" -le "$CURRENT_YEAR" ]; then
            VALID_CVES="$VALID_CVES $NORMALIZED"
        else
            INVALID_CVES="$INVALID_CVES $CVE (invalid year)"
        fi
    else
        INVALID_CVES="$INVALID_CVES $CVE (malformed)"
    fi
done

if [ -n "$INVALID_CVES" ]; then
    echo "CVE_VALIDATION=warning"
    echo "Invalid CVE format detected:$INVALID_CVES"
    echo "Standard format: CVE-YYYY-NNNNN (e.g., CVE-2024-12345)"
    exit 0
fi

if [ -n "$VALID_CVES" ]; then
    echo "CVE_VALIDATION=valid"
    echo "CVEs detected:$VALID_CVES"
fi

exit 0
