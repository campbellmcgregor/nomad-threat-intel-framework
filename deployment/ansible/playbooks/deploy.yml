---
# Deploy NOMAD Web GUI to Hetzner server
- name: Deploy NOMAD Web GUI
  hosts: nomad_servers
  become: yes
  vars_files:
    - ../inventory/group_vars/all.yml

  tasks:
    # Docker installation
    - name: Install Docker prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    # Application deployment
    - name: Create application directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ paths.app }}"
        - "{{ paths.data }}"
        - "{{ paths.backups }}"

    - name: Copy application files
      ansible.builtin.synchronize:
        src: ../../../web-intake-gui/
        dest: "{{ paths.app }}/"
        rsync_opts:
          - "--exclude=data/"
          - "--exclude=.env"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"

    - name: Create .env file
      ansible.builtin.template:
        src: ../templates/.env.j2
        dest: "{{ paths.app }}/.env"
        mode: '0600'

    - name: Create production docker-compose
      ansible.builtin.template:
        src: ../templates/docker-compose.prod.yml.j2
        dest: "{{ paths.app }}/docker-compose.prod.yml"
        mode: '0644'

    - name: Create Caddyfile
      ansible.builtin.template:
        src: ../templates/Caddyfile.j2
        dest: "{{ paths.app }}/Caddyfile"
        mode: '0644'

    - name: Build Docker image
      community.docker.docker_image:
        name: "{{ docker.image_name }}"
        tag: "{{ docker.image_tag }}"
        source: build
        build:
          path: "{{ paths.app }}"
        state: present
        force_source: yes

    - name: Start application with docker compose
      community.docker.docker_compose_v2:
        project_src: "{{ paths.app }}"
        files:
          - docker-compose.prod.yml
        state: present
        pull: never
      register: compose_result

    - name: Wait for application to be healthy
      ansible.builtin.uri:
        url: "http://localhost:8080/health"
        method: GET
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Deployment complete!

          Application URL: {{ 'https://' + app.domain if app.domain else 'http://' + ansible_host + ':8080' }}
          Health check: {{ health_check.json | default('OK') }}

          To publish reports, use:
          curl -X POST {{ 'https://' + app.domain if app.domain else 'http://' + ansible_host + ':8080' }}/api/v1/reports \
            -H "Authorization: Bearer $NOMAD_WEB_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"report_type": "threats", "title": "Test", "organization": "Test", "content": {"markdown": "# Test"}}'
